pipeline {
    agent {
        kubernetes {
            yaml """
                apiVersion: v1
                kind: Pod
                spec:
                  containers:
                  - name: gradle
                    image: gradle
                    command:
                    - sleep
                    args:
                    - 99d
                    volumeMounts:
                    - name: shared-storage
                      mountPath: /mnt        
                  - name: kaniko
                    image: gcr.io/kaniko-project/executor:debug
                    command:
                    - sleep
                    args:
                    - 9999999
                    volumeMounts:
                    - name: shared-storage
                      mountPath: /mnt
                    - name: kaniko-secret
                      mountPath: /kaniko/.docker
                  restartPolicy: Never
                  volumes:
                  - name: shared-storage
                    persistentVolumeClaim:
                      claimName: test2
                  - name: kaniko-secret
                    secret:
                        secretName: dockercred
                        items:
                        - key: .dockerconfigjson
                          path: config.json
            """
        }
    }
    
    stages {
        stage('Build a gradle project') {
            steps {
                git 'https://github.com/leopoldstotch1234/week5.git'
                container('gradle') {
                    sh '''
	            echo "151.101.0.215 repo.maven.apache.org" | tee -a /etc/hosts
                    cd Chapter08/sample1
                    sed -i 's/minimum = 0.2/minimum = 0.1/' build.gradle
                    sed -i '/checkstyle {/,/}/d' build.gradle 
                    sed -i '/checkstyle/d' build.gradle 
                    cat build.gradle
                    chmod +x gradlew
                    '''
                }
            }
        }
	stage("CheckStyle") {
	   steps{
            sh '''
            pwd
            cd Chapter08/sample1
            ./gradlew test --refresh-dependencies
            ./gradlew jacocoTestReport --refresh-dependencies
            '''
      		
	      publishHTML (target: [
        reportDir: 'Chapter08/sample1/build/reports/checkstyle',
	      reportFiles: 'main.html',
        reportName: "JaCoCo checkstyle"
        ])
        }
}

    }
}
